{% extends "base.html" %}

{% block title %}Client Magic - Dashboard{% endblock %}

{% block styles %}
{% include "components/dashboard_styles.html" %}
<style>
    /* Global dropzone styles */
    .global-dropzone {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(47, 133, 90, 0.2); /* Forest green with transparency */
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    .global-dropzone-active {
        display: flex !important;
    }
    .global-dropzone-content {
        background-color: white;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 500px;
        width: 90%;
        pointer-events: none;
        border: 2px dashed #2F855A;
    }
    
    /* Success indicator styles */
    .success-indicator {
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 2;
    }
    .success-indicator.show {
        opacity: 1;
    }
    
    /* Hide old success messages */
    .edit-success {
        display: none;
    }
    
    /* Flatpickr customization */
    .flatpickr-calendar {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-family: inherit;
        z-index: 9999 !important;
        padding-top: 10px !important; /* Add padding to make room for close button */
    }
    .flatpickr-day.selected {
        background: #2F855A !important;
        border-color: #2F855A !important;
    }
    .flatpickr-day:hover {
        background: rgba(47, 133, 90, 0.1);
    }
    .flatpickr-monthDropdown-months {
        font-weight: 600;
    }
    
    /* Modal field alignment */
    .modal-value {
        margin-left: -0.5em;
    }
    
    .modal-field.editing .flatpickr-input {
        margin-left: -0.5em;
    }
    
    /* Close button for flatpickr */
    .flatpickr-close-button {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background: #f0f0f0;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        cursor: pointer;
        z-index: 10000;
        line-height: 1;
        color: #555;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .flatpickr-close-button:hover {
        background: #e0e0e0;
        color: #333;
    }
    
    /* Prevent scrolling when calendar is open */
    body.calendar-open {
        overflow: hidden;
    }
    
    /* Ensure the calendar doesn't get cut off */
    .flatpickr-calendar.open {
        position: fixed !important;
    }
    
    /* Editable field hover styles */
    .modal-field {
        position: relative;
    }
    
    .modal-value[data-field]:not(.editing) {
        position: relative;
        padding-right: 24px; /* Make room for the edit icon */
        cursor: pointer; /* Show pointer cursor on hover */
        transition: background-color 0.2s ease;
    }
    
    .modal-value[data-field]:not(.editing):hover {
        background-color: rgba(47, 133, 90, 0.05); /* Light green background on hover */
        border-radius: 4px;
    }
    
    .modal-value[data-field]:not(.editing)::after {
        content: '\f044'; /* FontAwesome edit icon */
        font-family: 'Font Awesome 5 Free';
        font-weight: 400; /* Regular weight for the edit icon */
        position: absolute;
        right: 4px;
        top: 50%;
        transform: translateY(-50%);
        color: #2F855A; /* Forest green */
        opacity: 0;
        transition: opacity 0.2s ease;
        font-size: 14px;
        pointer-events: none; /* Ensure the icon doesn't interfere with clicks */
        z-index: 1; /* Ensure the icon is above other elements */
    }
    
    /* For multi-line fields like notes, position the icon at the top */
    .modal-value[data-field="notes"]:not(.editing)::after {
        top: 12px;
        transform: none;
    }
    
    /* Add a subtle border on hover for better visual feedback */
    .modal-value[data-field]:not(.editing):hover::after {
        opacity: 1;
    }
    
    /* Ensure the notes field has proper padding for the icon */
    .modal-value[data-field="notes"]:not(.editing) {
        padding-top: 8px;
        padding-bottom: 8px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Global Dropzone Overlay -->
<div id="globalDropzone" class="global-dropzone">
    <div class="global-dropzone-content">
        <i class="fas fa-cloud-upload-alt text-6xl text-forest-green mb-4"></i>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">Drop to Upload</h3>
        <p class="text-gray-600">Release your CSV file to automatically import contacts</p>
    </div>
</div>

<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">
            Dashboard
        </h1>
    </div>

    <!-- Notification Messages -->
    {% include "components/notifications.html" %}

    <!-- Action Buttons -->
    {% include "components/action_buttons.html" %}

    <!-- Search Bar -->
    {% include "components/search_bar.html" %}

    <!-- Contacts Table -->
    {% include "components/contacts_table.html" %}
</div>

<!-- Modals -->
{% include "components/contact_detail_modal.html" %}

<!-- Import Modal -->
<div id="importModal" class="hidden fixed inset-0 z-10 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75 modal-backdrop"></div>
        </div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Import Contacts</h3>
                            <button type="button" class="modal-close text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form action="/dashboard" method="post" enctype="multipart/form-data" class="space-y-4">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div>
                                <label for="csv_file" class="block text-sm font-medium text-gray-700 mb-1">Select CSV File</label>
                                <input type="file" name="csv_file" id="csv_file" class="form-input w-full" accept=".csv">
                            </div>
                            <div class="text-sm text-gray-500">
                                <p>CSV should have headers: name, cell, email, mailing_address, notes, birthday (MM-DD format), facebook, instagram, twitter</p>
                                <p class="mt-2">
                                    <a href="/download/sample_csv" class="text-forest-green hover:underline">
                                        <i class="fas fa-download mr-1"></i> Download Sample CSV
                                    </a>
                                </p>
                            </div>
                            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                                <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-forest-green text-base font-medium text-white hover:bg-forest-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forest-green sm:ml-3 sm:w-auto sm:text-sm">
                                    Import
                                </button>
                                <button type="button" class="modal-cancel mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forest-green sm:mt-0 sm:w-auto sm:text-sm">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Contact Modal -->
<div id="addContactModal" class="hidden fixed inset-0 z-10 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75 modal-backdrop"></div>
        </div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Add New Contact</h3>
                            <button type="button" class="modal-close text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form action="/add_contact" method="post" class="space-y-4">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div>
                                <label for="name" class="form-label">Name</label>
                                <input type="text" name="name" id="name" class="form-input w-full" required>
                            </div>
                            <div>
                                <label for="cell" class="form-label">Cell Phone</label>
                                <input type="tel" name="cell" id="cell" class="form-input w-full">
                            </div>
                            <div>
                                <label for="email" class="form-label">Email</label>
                                <input type="email" name="email" id="email" class="form-input w-full">
                            </div>
                            <div>
                                <label for="mailing_address" class="form-label">Mailing Address</label>
                                <input type="text" name="mailing_address" id="mailing_address" class="form-input w-full">
                            </div>
                            <div>
                                <label for="birthday" class="form-label">Birthday (MM-DD)</label>
                                <input type="text" name="birthday" id="birthday" class="form-input w-full" placeholder="MM-DD">
                            </div>
                            <div>
                                <label for="notes" class="form-label">Notes</label>
                                <textarea name="notes" id="notes" class="form-input w-full" rows="3"></textarea>
                            </div>
                            <div>
                                <label for="facebook" class="form-label">Facebook</label>
                                <input type="text" name="facebook" id="facebook" class="form-input w-full">
                            </div>
                            <div>
                                <label for="instagram" class="form-label">Instagram</label>
                                <input type="text" name="instagram" id="instagram" class="form-input w-full">
                            </div>
                            <div>
                                <label for="twitter" class="form-label">Twitter</label>
                                <input type="text" name="twitter" id="twitter" class="form-input w-full">
                            </div>
                            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                                <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-forest-green text-base font-medium text-white hover:bg-forest-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forest-green sm:ml-3 sm:w-auto sm:text-sm">
                                    Add Contact
                                </button>
                                <button type="button" class="modal-cancel mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forest-green sm:mt-0 sm:w-auto sm:text-sm">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete All Records Confirmation Modal -->
<div id="deleteAllModal" class="hidden fixed inset-0 z-10 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75 modal-backdrop"></div>
        </div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-danger-light sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-exclamation-triangle text-danger"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Delete All Contacts</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                Are you sure you want to delete all contacts? This action cannot be undone.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <form action="/delete_all_contacts" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-danger text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Delete All
                    </button>
                </form>
                <button type="button" class="modal-cancel mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forest-green sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Duplicates Confirmation Modal -->
<div id="removeDuplicatesModal" class="hidden fixed inset-0 z-10 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75 modal-backdrop"></div>
        </div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-warning-light sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-exclamation-circle text-warning"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Remove Duplicate Contacts</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                This will remove contacts with duplicate email addresses or phone numbers, keeping only the most recently updated record. This action can be undone for 30 days.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <form action="/remove_duplicates" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-warning text-base font-medium text-white hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Remove Duplicates
                    </button>
                </form>
                <button type="button" class="modal-cancel mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forest-green sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Modal elements
        const contactDetailModal = document.getElementById('contactDetailModal');
        const importModal = document.getElementById('importModal');
        const addContactModal = document.getElementById('addContactModal');
        const deleteAllModal = document.getElementById('deleteAllModal');
        const removeDuplicatesModal = document.getElementById('removeDuplicatesModal');
        
        // Close buttons for contact detail modal
        const closeDetailModalBtn = document.getElementById('closeDetailModal');
        const closeDetailBtn = document.getElementById('closeDetailBtn');
        
        // Action buttons
        const addContactBtn = document.getElementById('addContactBtn');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const deleteAllBtn = document.getElementById('deleteAllBtn');
        const removeDuplicatesBtn = document.getElementById('removeDuplicatesBtn');
        
        // Close alert buttons
        const closeAlertButtons = document.querySelectorAll('.close-alert');
        closeAlertButtons.forEach(button => {
            button.addEventListener('click', function() {
                this.parentElement.style.display = 'none';
            });
        });
        
        // Add event listener for flatpickr close button
        document.addEventListener('click', function(e) {
            // Check if the click is on the flatpickr close button
            if (e.target && e.target.closest('.flatpickr-calendar') && 
                e.clientX >= e.target.closest('.flatpickr-calendar').getBoundingClientRect().right - 30 &&
                e.clientY <= e.target.closest('.flatpickr-calendar').getBoundingClientRect().top + 30) {
                
                // Find and close all open flatpickr instances
                const openCalendars = document.querySelectorAll('.flatpickr-calendar.open');
                if (openCalendars.length > 0) {
                    // Find the flatpickr instance and close it
                    const input = document.querySelector('.flatpickr-input');
                    if (input && input._flatpickr) {
                        input._flatpickr.close();
                    }
                }
            }
        });
        
        // Function to open a modal properly
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // Reset any previous state
                modal.classList.remove('hidden');
                
                // Ensure backdrop is visible
                const backdrop = modal.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.style.opacity = '0.75';
                }
                
                // Re-initialize click handlers for this modal
                setupModalClickHandlers(modal);
            }
        }
        
        // Function to close a modal properly
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // Setup event handlers for a specific modal
        function setupModalClickHandlers(modal) {
            // Store the form action if this is the contact detail modal
            let deleteFormAction = '';
            if (modal.id === 'contactDetailModal') {
                const deleteForm = modal.querySelector('form');
                if (deleteForm) {
                    deleteFormAction = deleteForm.action;
                }
            }
            
            // Remove any existing event listeners (to prevent duplicates)
            const newModal = modal.cloneNode(true);
            modal.parentNode.replaceChild(newModal, modal);
            
            // Restore the form action if this is the contact detail modal
            if (newModal.id === 'contactDetailModal' && deleteFormAction) {
                const deleteForm = newModal.querySelector('form');
                if (deleteForm) {
                    deleteForm.action = deleteFormAction;
                }
            }
            
            // Add click handlers to close buttons within this modal
            newModal.querySelectorAll('.modal-close, .modal-cancel').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeModal(newModal.id);
                });
            });
            
            // Add click handler to the modal container for outside clicks
            newModal.addEventListener('click', function(e) {
                // If clicking directly on the modal container or on a backdrop element
                if (e.target === this || e.target.classList.contains('modal-backdrop')) {
                    closeModal(this.id);
                }
            });
            
            // Prevent clicks on modal content from closing the modal
            const modalContent = newModal.querySelector('.inline-block') || newModal.querySelector('.relative');
            if (modalContent) {
                modalContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            // If this is the contact detail modal, re-setup the editable fields
            if (newModal.id === 'contactDetailModal') {
                setupEditableFields();
            }
        }
        
        // Initialize all modals on page load
        document.querySelectorAll('.fixed').forEach(modal => {
            setupModalClickHandlers(modal);
        });
        
        // Close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Check if any field is in edit mode
                const editingFields = document.querySelectorAll('.modal-value.editing');
                if (editingFields.length > 0) {
                    // Don't close the modal if a field is being edited
                    return;
                }
                
                // Find visible modals and hide them
                document.querySelectorAll('.fixed:not(.hidden)').forEach(modal => {
                    closeModal(modal.id);
                });
            }
        });
        
        // Action button event listeners
        if (addContactBtn) {
            addContactBtn.addEventListener('click', function() {
                openModal('addContactModal');
            });
        }
        
        if (importBtn) {
            importBtn.addEventListener('click', function() {
                openModal('importModal');
            });
        }
        
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                window.location.href = '/download_all_contacts';
            });
        }
        
        if (deleteAllBtn) {
            deleteAllBtn.addEventListener('click', function() {
                openModal('deleteAllModal');
            });
        }
        
        if (removeDuplicatesBtn) {
            removeDuplicatesBtn.addEventListener('click', function() {
                openModal('removeDuplicatesModal');
            });
        }
        
        // Contact row click event
        const contactRows = document.querySelectorAll('.contact-row');
        contactRows.forEach(row => {
            row.addEventListener('click', function() {
                const contactId = this.getAttribute('data-contact-id');
                openContactDetailModal(contactId);
            });
        });

        // Function to open contact detail modal
        function openContactDetailModal(contactId) {
            fetchContactDetails(contactId);
        }

        // Function to fetch contact details
        function fetchContactDetails(contactId) {
            console.log('Fetching contact details for ID:', contactId);
            fetch(`/get_contact/${contactId}`)
                .then(response => response.json())
                .then(data => {
                    // Populate the modal with contact data
                    document.getElementById('contactName').textContent = data.name || '';
                    document.getElementById('contactInitial').textContent = data.name ? data.name[0].toUpperCase() : '';
                    
                    // Set the delete form action
                    const deleteForm = document.getElementById('deleteContactForm');
                    if (deleteForm) {
                        deleteForm.action = `/delete_contact/${contactId}`;
                        console.log('Delete form action set to:', deleteForm.action);
                        
                        // Add a direct event listener to the delete button
                        const deleteButton = deleteForm.querySelector('button[type="submit"]');
                        if (deleteButton) {
                            // Remove any existing listeners
                            const newDeleteButton = deleteButton.cloneNode(true);
                            deleteButton.parentNode.replaceChild(newDeleteButton, deleteButton);
                            
                            // Add new listener
                            newDeleteButton.addEventListener('click', function(e) {
                                e.preventDefault();
                                console.log('Delete button clicked for contact:', contactId);
                                
                                if (confirm('Are you sure you want to delete this contact?')) {
                                    console.log('Deleting contact:', contactId);
                                    console.log('Form action:', deleteForm.action);
                                    
                                    // Use the form's action directly
                                    const formAction = deleteForm.action;
                                    console.log('Using form action:', formAction);
                                    
                                    // Create FormData from the form
                                    const formData = new FormData(deleteForm);
                                    
                                    // Submit the form programmatically
                                    fetch(formAction, {
                                        method: 'POST',
                                        headers: {
                                            'X-Requested-With': 'XMLHttpRequest'
                                        },
                                        body: formData
                                    })
                                    .then(response => {
                                        console.log('Delete response status:', response.status);
                                        return response.json();
                                    })
                                    .then(data => {
                                        console.log('Delete response data:', data);
                                        if (data.success) {
                                            // Close the modal
                                            closeModal('contactDetailModal');
                                            
                                            // Remove the row from the table if it exists
                                            const row = document.querySelector(`.contact-row[data-contact-id="${contactId}"]`);
                                            if (row) {
                                                row.remove();
                                            }
                                            
                                            // Show success message
                                            alert('Contact deleted successfully');
                                        } else {
                                            alert('Error deleting contact: ' + data.message);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error deleting contact:', error);
                                        alert('Error deleting contact. Please try again.');
                                    });
                                }
                            });
                        } else {
                            console.error('Delete button not found in the form');
                        }
                    } else {
                        console.error('Delete form not found in the modal');
                    }
                    
                    // Populate all fields
                    document.getElementById('detailName').textContent = data.name || '';
                    document.getElementById('detailCell').textContent = data.cell || '';
                    document.getElementById('detailEmail').textContent = data.email || '';
                    document.getElementById('detailAddress').textContent = data.mailing_address || '';
                    document.getElementById('detailNotes').textContent = data.notes || '';
                    
                    // Format date fields - these are not editable
                    document.getElementById('detailDateAdded').textContent = formatDate(data.dateAdded) || '';
                    document.getElementById('dateAddedDisplay').textContent = formatDate(data.dateAdded) || '';
                    
                    // Format birthday in MMM DD format
                    document.getElementById('detailBirthday').textContent = formatBirthday(data.birthday) || '';
                    
                    // Format and display last updated dates as help text
                    const emailUpdatedText = data.email_updated ? `Updated: ${formatDate(data.email_updated)}` : '';
                    document.getElementById('detailEmailUpdated').textContent = emailUpdatedText;
                    
                    const cellUpdatedText = data.cell_updated ? `Updated: ${formatDate(data.cell_updated)}` : '';
                    document.getElementById('detailCellUpdated').textContent = cellUpdatedText;
                    
                    document.getElementById('detailFacebook').textContent = data.facebook || '';
                    document.getElementById('detailInstagram').textContent = data.instagram || '';
                    document.getElementById('detailTwitter').textContent = data.twitter || '';
                    
                    // Store the contact ID for editing
                    contactDetailModal.setAttribute('data-contact-id', contactId);
                    
                    // Show the modal
                    openModal('contactDetailModal');
                })
                .catch(error => {
                    console.error('Error fetching contact details:', error);
                });
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // Format birthday for display (MMM DD format)
        function formatBirthday(birthdayString) {
            if (!birthdayString) return '';
            
            // Handle MM-DD format
            if (birthdayString.includes('-')) {
                const [month, day] = birthdayString.split('-');
                if (month && day) {
                    const date = new Date(2000, parseInt(month)-1, parseInt(day));
                    return date.toLocaleDateString('default', { month: 'short', day: 'numeric' });
                }
            }
            
            // Return as is if we can't parse it
            return birthdayString;
        }

        // Setup editable fields in the modal
        function setupEditableFields() {
            console.log('Setting up editable fields');
            const editableFields = document.querySelectorAll('#contactDetailModal .modal-value[data-field]');
            
            editableFields.forEach(field => {
                // Skip fields that shouldn't be editable
                const fieldName = field.getAttribute('data-field');
                if (!fieldName || fieldName === 'date_added' || fieldName === 'email_updated' || fieldName === 'cell_updated') {
                    return;
                }
                
                console.log('Adding click listener to field:', fieldName);
                
                // Remove any existing listeners by cloning and replacing
                const newField = field.cloneNode(true);
                field.parentNode.replaceChild(newField, field);
                
                // Add the click event listener to the new field
                newField.addEventListener('click', function(e) {
                    console.log('Field clicked:', fieldName);
                    if (!this.classList.contains('editing')) {
                        makeFieldEditable(this);
                    }
                });
            });
        }

        // Make a field editable
        function makeFieldEditable(field) {
            const fieldName = field.getAttribute('data-field');
            const currentValue = field.textContent;
            const contactId = contactDetailModal.getAttribute('data-contact-id');
            
            // Store original value for potential cancellation
            field.setAttribute('data-original-value', currentValue);
            
            // Create input element based on field type
            let inputElement;
            let flatpickrInstance = null;
            
            if (fieldName === 'notes') {
                inputElement = document.createElement('textarea');
                inputElement.rows = 3;
            } else if (fieldName === 'birthday') {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.placeholder = 'MMM DD (e.g. Jan 15)';
                inputElement.className = 'w-full p-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-forest-green focus:border-forest-green';
                
                // Add datepicker immediately
                if (typeof flatpickr !== 'undefined') {
                    // Add the input to DOM first so flatpickr can find it
                    field.innerHTML = '';
                    field.appendChild(inputElement);
                    
                    // Initialize flatpickr
                    flatpickrInstance = flatpickr(inputElement, {
                        dateFormat: "M d",
                        defaultDate: currentValue,
                        allowInput: true,
                        monthSelectorType: "static",
                        disableMobile: true,
                        onOpen: function() {
                            // Lock scrolling when calendar opens
                            document.body.classList.add('calendar-open');
                            
                            // Add custom close button
                            setTimeout(() => {
                                const calendar = document.querySelector('.flatpickr-calendar.open');
                                if (calendar && !calendar.querySelector('.flatpickr-close-button')) {
                                    const closeBtn = document.createElement('button');
                                    closeBtn.className = 'flatpickr-close-button';
                                    closeBtn.innerHTML = 'Ã—';
                                    closeBtn.addEventListener('click', function() {
                                        if (flatpickrInstance) {
                                            flatpickrInstance.close();
                                        }
                                    });
                                    calendar.appendChild(closeBtn);
                                }
                            }, 0);
                        },
                        onClose: function(selectedDates, dateStr) {
                            // Unlock scrolling when calendar closes
                            document.body.classList.remove('calendar-open');
                            
                            if (dateStr) {
                                // Automatically save when a date is selected
                                saveFieldEdit(field, dateStr, fieldName, contactId);
                            }
                        }
                    });
                    
                    // Open the calendar immediately
                    setTimeout(() => {
                        flatpickrInstance.open();
                    }, 50);
                }
            } else {
                inputElement = document.createElement('input');
                inputElement.type = fieldName.includes('email') ? 'email' : 'text';
            }
            
            // Set input value and styling
            inputElement.value = currentValue;
            if (fieldName !== 'birthday') { // Already set for birthday above
                inputElement.className = 'w-full p-2 border border-gray-200 rounded-md focus:ring-2 focus:ring-forest-green focus:border-forest-green';
            }
            
            // Create save and cancel buttons
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'edit-actions';
            
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.className = 'edit-save-btn';
            
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.className = 'edit-cancel-btn';
            
            // Add event listeners
            saveButton.addEventListener('click', function() {
                if (flatpickrInstance) {
                    flatpickrInstance.close();
                }
                saveFieldEdit(field, inputElement.value, fieldName, contactId);
            });
            
            cancelButton.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent event bubbling
                if (flatpickrInstance) {
                    flatpickrInstance.close();
                }
                cancelFieldEdit(field, currentValue);
            });
            
            // Add blur event to exit edit mode when clicking outside
            inputElement.addEventListener('blur', function(e) {
                // Don't cancel if the related target is the flatpickr calendar or the save/cancel buttons
                if (e.relatedTarget && 
                    (e.relatedTarget.classList.contains('flatpickr-day') || 
                     e.relatedTarget.classList.contains('flatpickr-month') ||
                     e.relatedTarget.classList.contains('flatpickr-monthDropdown-month') ||
                     e.relatedTarget.classList.contains('flatpickr-close-button') ||
                     e.relatedTarget === saveButton || 
                     e.relatedTarget === cancelButton)) {
                    return;
                }
                
                // Also don't cancel if we're clicking inside the flatpickr calendar
                if (e.relatedTarget && e.relatedTarget.closest('.flatpickr-calendar')) {
                    return;
                }
                
                // For birthday field, only cancel if we're clicking outside the flatpickr
                if (fieldName === 'birthday') {
                    // Check if flatpickr is open
                    const flatpickrCalendar = document.querySelector('.flatpickr-calendar.open');
                    if (flatpickrCalendar) {
                        // Don't cancel if the flatpickr is open
                        return;
                    }
                }
                
                cancelFieldEdit(field, currentValue);
            });
            
            // Add keydown event to handle ESC key and Enter key
            inputElement.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    e.stopPropagation(); // Prevent modal from closing
                    if (flatpickrInstance) {
                        flatpickrInstance.close();
                    }
                    cancelFieldEdit(field, currentValue);
                } else if (e.key === 'Enter') {
                    // For regular inputs, submit on Enter
                    if (inputElement.tagName.toLowerCase() !== 'textarea' || (e.metaKey || e.ctrlKey)) {
                        e.preventDefault(); // Prevent default behavior (newline in textarea)
                        if (flatpickrInstance) {
                            flatpickrInstance.close();
                        }
                        saveFieldEdit(field, inputElement.value, fieldName, contactId);
                    }
                }
            });
            
            // Add elements to the DOM
            actionsDiv.appendChild(saveButton);
            actionsDiv.appendChild(cancelButton);
            
            // Only append to DOM if not already done for birthday
            if (fieldName !== 'birthday') {
                field.innerHTML = '';
                field.appendChild(inputElement);
            }
            
            field.appendChild(actionsDiv);
            field.classList.add('editing');
            
            // Focus the input
            inputElement.focus();
        }

        // Save field edit
        function saveFieldEdit(field, newValue, fieldName, contactId) {
            // Prepare data for the API call
            const data = {
                field: fieldName,
                value: newValue
            };
            
            // Make API call to update the contact
            fetch(`/update_contact/${contactId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Format the display value if needed
                    let displayValue = newValue;
                    
                    // Format birthday if it has a specific format
                    if (fieldName === 'birthday' && newValue) {
                        try {
                            // Try to parse and format the date
                            const dateParts = newValue.split(/[\/\-\s]/);
                            if (dateParts.length >= 2) {
                                const month = isNaN(dateParts[0]) ? dateParts[0] : new Date(2000, parseInt(dateParts[0])-1, 1).toLocaleString('default', { month: 'short' });
                                const day = dateParts[1];
                                displayValue = `${month} ${day}`;
                            }
                        } catch (e) {
                            console.error('Error formatting date:', e);
                        }
                    }
                    
                    // Update the field with the new value
                    field.textContent = displayValue;
                    field.classList.remove('editing');
                    
                    // Show success indicator
                    const successIndicator = field.closest('.modal-field').querySelector('.success-indicator');
                    if (successIndicator) {
                        successIndicator.classList.remove('hidden');
                        successIndicator.style.opacity = '1';
                        setTimeout(() => {
                            successIndicator.style.opacity = '0';
                            setTimeout(() => {
                                successIndicator.classList.add('hidden');
                            }, 300);
                        }, 2000);
                    }
                    
                    // Also update the row in the table if visible
                    updateTableRow(contactId, fieldName, displayValue);
                    
                    // Update contact name in modal header if name was changed
                    if (fieldName === 'name') {
                        document.getElementById('contactName').textContent = displayValue;
                        document.getElementById('contactInitial').textContent = displayValue ? displayValue[0].toUpperCase() : '';
                    }
                } else {
                    // Show error and revert to original value
                    alert('Error updating contact: ' + data.message);
                    field.textContent = field.getAttribute('data-original-value') || '';
                    field.classList.remove('editing');
                }
            })
            .catch(error => {
                console.error('Error updating contact:', error);
                field.textContent = field.getAttribute('data-original-value') || '';
                field.classList.remove('editing');
            });
        }

        // Cancel field edit
        function cancelFieldEdit(field, originalValue) {
            field.textContent = originalValue || field.getAttribute('data-original-value') || '';
            field.classList.remove('editing');
        }

        // Update table row after edit
        function updateTableRow(contactId, fieldName, newValue) {
            const row = document.querySelector(`.contact-row[data-contact-id="${contactId}"]`);
            if (!row) return;
            
            if (fieldName === 'name') {
                const nameElement = row.querySelector('.text-sm.font-medium');
                if (nameElement) nameElement.textContent = newValue;
                
                const initialElement = row.querySelector('.text-forest-green.font-semibold');
                if (initialElement) initialElement.textContent = newValue ? newValue[0].toUpperCase() : '';
            }
            
            if (fieldName === 'cell') {
                const cellElement = row.querySelector('td:nth-child(2) .hidden.md\\:inline');
                if (cellElement) cellElement.textContent = newValue || '-';
                
                const cellLink = row.querySelector('td:nth-child(2) a');
                if (cellLink) {
                    if (newValue) {
                        cellLink.href = `tel:${newValue}`;
                        cellLink.classList.remove('text-gray-300');
                        cellLink.classList.add('text-forest-green');
                    } else {
                        cellLink.removeAttribute('href');
                        cellLink.classList.remove('text-forest-green');
                        cellLink.classList.add('text-gray-300');
                    }
                }
            }
            
            if (fieldName === 'email') {
                const emailElement = row.querySelector('td:nth-child(3) .hidden.md\\:inline');
                if (emailElement) emailElement.textContent = newValue || '-';
                
                const emailLink = row.querySelector('td:nth-child(3) a');
                if (emailLink) {
                    if (newValue) {
                        emailLink.href = `mailto:${newValue}`;
                        emailLink.classList.remove('text-gray-300');
                        emailLink.classList.add('text-forest-green');
                    } else {
                        emailLink.removeAttribute('href');
                        emailLink.classList.remove('text-forest-green');
                        emailLink.classList.add('text-gray-300');
                    }
                }
            }
            
            if (fieldName === 'birthday') {
                const birthdayElement = row.querySelector('td:nth-child(4) .text-sm');
                if (birthdayElement) birthdayElement.textContent = newValue || '-';
            }
            
            if (fieldName === 'notes') {
                const notesElement = row.querySelector('td:nth-child(5) .text-sm');
                if (notesElement) notesElement.textContent = newValue || '-';
            }
        }

        // Add more JavaScript functionality as needed
        
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('.contact-row');
                
                rows.forEach(row => {
                    const name = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
                    const cell = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    const email = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    const notes = row.querySelector('td:nth-child(5)') ? row.querySelector('td:nth-child(5)').textContent.toLowerCase() : '';
                    
                    if (name.includes(searchTerm) || cell.includes(searchTerm) || email.includes(searchTerm) || notes.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }
        
        // Table sorting functionality
        const sortableHeaders = document.querySelectorAll('.sortable-header');
        let currentSort = { column: null, direction: 'asc' };
        
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const column = this.getAttribute('data-sort');
                const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
                
                // Update sort icons
                document.querySelectorAll('.sort-icon i').forEach(icon => {
                    icon.className = 'fas fa-sort text-gray-400';
                });
                
                const sortIcon = this.querySelector('.sort-icon i');
                sortIcon.className = `fas fa-sort-${direction === 'asc' ? 'up' : 'down'} text-forest-green`;
                
                // Sort the table
                const tbody = document.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                
                rows.sort((a, b) => {
                    let aValue, bValue;
                    
                    if (column === 'name') {
                        aValue = a.querySelector('td:nth-child(1)').textContent.trim().toLowerCase();
                        bValue = b.querySelector('td:nth-child(1)').textContent.trim().toLowerCase();
                    } else if (column === 'birthday') {
                        aValue = a.querySelector('td:nth-child(4)').textContent.trim().toLowerCase();
                        bValue = b.querySelector('td:nth-child(4)').textContent.trim().toLowerCase();
                        
                        // Handle empty values
                        if (aValue === '-') aValue = 'z'; // Sort empty values to the end
                        if (bValue === '-') bValue = 'z';
                    }
                    
                    if (direction === 'asc') {
                        return aValue > bValue ? 1 : -1;
                    } else {
                        return aValue < bValue ? 1 : -1;
                    }
                });
                
                // Re-append rows in the new order
                rows.forEach(row => tbody.appendChild(row));
                
                // Update current sort
                currentSort = { column, direction };
            });
        });
        
        // File drop zone functionality
        const fileInput = document.getElementById('csv_file');
        const importForm = fileInput ? fileInput.closest('form') : null;
        const globalDropzone = document.getElementById('globalDropzone');
        
        if (fileInput && importForm) {
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Counter to track drag enter/leave events
            let dragCounter = 0;
            
            // Show global dropzone when dragging over the document
            document.addEventListener('dragenter', function(e) {
                dragCounter++;
                if (e.dataTransfer.types && e.dataTransfer.types.includes('Files')) {
                    globalDropzone.classList.add('global-dropzone-active');
                    console.log('Drag enter - showing dropzone', dragCounter);
                }
            });
            
            // Hide global dropzone when leaving the document
            document.addEventListener('dragleave', function(e) {
                dragCounter--;
                if (dragCounter === 0) {
                    globalDropzone.classList.remove('global-dropzone-active');
                    console.log('Drag leave - hiding dropzone', dragCounter);
                }
            });
            
            // Keep dropzone visible during dragover
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (e.dataTransfer.types && e.dataTransfer.types.includes('Files')) {
                    if (!globalDropzone.classList.contains('global-dropzone-active')) {
                        globalDropzone.classList.add('global-dropzone-active');
                        console.log('Drag over - showing dropzone');
                    }
                }
            });
            
            // Handle file drop anywhere on the document
            document.addEventListener('drop', function(e) {
                dragCounter = 0;
                globalDropzone.classList.remove('global-dropzone-active');
                console.log('Drop - hiding dropzone');
                
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0 && isCSVFile(files[0])) {
                    // Set the file input value
                    fileInput.files = files;
                    
                    // Show the import modal if it's not already visible
                    openModal('importModal');
                    
                    // Automatically submit the form
                    importForm.submit();
                }
            });
            
            // Helper function to check if file is a CSV
            function isCSVFile(file) {
                return file.name.toLowerCase().endsWith('.csv');
            }
        }
    });
</script>
{% endblock %} 